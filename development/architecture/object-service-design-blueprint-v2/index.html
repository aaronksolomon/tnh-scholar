
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="*A practical, opinionated blueprint for the overall direction for design, implementation, and evolution of complex objects and API-backed services across the TNH Scholar suite. It presents the big picture first, then the fine details, and ends with boilerplate templates you can copy‑paste to sketch new systems.*">
      
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>Object–Service Design Blueprint (Integrated) - TNH Scholar Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a40c8224.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#objectservice-design-blueprint-integrated" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="TNH Scholar Documentation" class="md-header__button md-logo" aria-label="TNH Scholar Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TNH Scholar Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Object–Service Design Blueprint (Integrated)
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aaronksolomon/tnh-scholar" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="TNH Scholar Documentation" class="md-nav__button md-logo" aria-label="TNH Scholar Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    TNH Scholar Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aaronksolomon/tnh-scholar" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/quick-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Start
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/patterns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pattern System
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/best-practices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Best Practices
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CLI Tools
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            CLI Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cli/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cli/tnh-fab/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tnh-fab
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cli/audio-transcribe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    audio-transcribe
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cli/ytt-fetch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ytt-fetch
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cli/nfmt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nfmt
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cli/token-count/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    token-count
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cli/tnh-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tnh-setup
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Reference
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Development
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    System Overview
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Design
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design-guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design Guide
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_2" >
        
          
          <label class="md-nav__link" for="__nav_6_3_2" id="__nav_6_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CLI Design
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3_2">
            <span class="md-nav__icon md-icon"></span>
            CLI Design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_2_1" >
        
          
          <label class="md-nav__link" for="__nav_6_3_2_1" id="__nav_6_3_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    TNH-FAB
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_3_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3_2_1">
            <span class="md-nav__icon md-icon"></span>
            TNH-FAB
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/tnh-fab/design/text-processing-cli-design-v1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    v1
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/tnh-fab/design/text-processing-cli-design-v2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    v2
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_2_2" >
        
          
          <label class="md-nav__link" for="__nav_6_3_2_2" id="__nav_6_3_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    YTT-Fetch
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_3_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3_2_2">
            <span class="md-nav__icon md-icon"></span>
            YTT-Fetch
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/ytt-fetch/adr/adr-yf00-overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  
    
  
  
    <span class="md-status md-status--historical"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/ytt-fetch/adr/adr-yf01-transcript-source-handling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Transcript Source
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/ytt-fetch/adr/adr-yf02-yt-dlp-transcripts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YT-DLP Integration
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/ytt-fetch/design/yt-dlp-vs-youtube-api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Comparison
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/setup-tnh/design/setup-design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SETUP-TNH
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/docs-design/design/documentation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docs-Design
  </span>
  
    
  
  
    <span class="md-status md-status--processing"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4_2" >
        
          
          <label class="md-nav__link" for="__nav_6_4_2" id="__nav_6_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Docs-Planning
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4_2">
            <span class="md-nav__icon md-icon"></span>
            Docs-Planning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs-design/planning/roadmap.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Roadmap
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs-design/planning/maintenance.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Maintenance
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5" >
        
          
          <label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Research
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            Research
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../gpt_4o_search_query_text_pair_testing/testing_input_output.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Query Generation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../gpt_4o_translations_experiments/passage_test.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Translation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../translation_research.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Translation Research
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../preliminary_feasibility_study.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Feasibility Study
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-big-picture-at-a-glance" class="md-nav__link">
    <span class="md-ellipsis">
      0. Big Picture (At a Glance)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="0. Big Picture (At a Glance)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architectural-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Architectural Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unified-layer-model" class="md-nav__link">
    <span class="md-ellipsis">
      Unified Layer Model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-contracts" class="md-nav__link">
    <span class="md-ellipsis">
      Core Contracts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-design-goals-principles" class="md-nav__link">
    <span class="md-ellipsis">
      1. Design Goals &amp; Principles
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Design Goals & Principles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-core-design-goals" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 Core Design Goals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-rule-of-thumb" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 Rule of Thumb
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-core-concepts-naming-taxonomy" class="md-nav__link">
    <span class="md-ellipsis">
      2. Core Concepts &amp; Naming Taxonomy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Core Concepts & Naming Taxonomy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-configuration-runtime-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 Configuration &amp; Runtime Concepts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-response-result-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 Response &amp; Result Concepts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-architectural-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 Architectural Concepts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-layer-structure-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      3. Layer Structure &amp; Responsibilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Layer Structure & Responsibilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-conceptual-layers" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Conceptual Layers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-dependency-direction" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 Dependency Direction
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-configuration-taxonomy" class="md-nav__link">
    <span class="md-ellipsis">
      4. Configuration Taxonomy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Configuration Taxonomy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-settings-application-wide" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Settings (Application-wide)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-transport-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Transport Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-policy-structures" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 Policy Structures
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-policy-precedence" class="md-nav__link">
    <span class="md-ellipsis">
      4.4 Policy Precedence
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-canonical-domain-envelope" class="md-nav__link">
    <span class="md-ellipsis">
      5. Canonical Domain Envelope
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Canonical Domain Envelope">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-envelope-structure" class="md-nav__link">
    <span class="md-ellipsis">
      5.1 Envelope Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-envelope-invariants" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 Envelope Invariants
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-service-protocols" class="md-nav__link">
    <span class="md-ellipsis">
      6. Service Protocols
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Service Protocols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-protocol-design-rules" class="md-nav__link">
    <span class="md-ellipsis">
      6.1 Protocol Design Rules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-async-job-service-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      6.2 Async Job Service Protocol
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-sync-requestresponse-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 Sync Request/Response Protocol
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64-genai-service-protocol-example" class="md-nav__link">
    <span class="md-ellipsis">
      6.4 GenAI Service Protocol (Example)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-transport-models-domain-models" class="md-nav__link">
    <span class="md-ellipsis">
      7. Transport Models &amp; Domain Models
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Transport Models & Domain Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-transport-models-at-boundaries" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 Transport Models (at boundaries)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-domain-models" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 Domain Models
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-adapter-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      8. Adapter Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Adapter Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-adapter-role-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 Adapter Role &amp; Responsibilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-bi-directional-mapping-contract" class="md-nav__link">
    <span class="md-ellipsis">
      8.2 Bi-Directional Mapping Contract
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-adapter-boundary-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      8.3 Adapter Boundary Diagram
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84-sync-adapter-pattern-genai" class="md-nav__link">
    <span class="md-ellipsis">
      8.4 Sync Adapter Pattern (GenAI)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#85-async-adapter-pattern-diarization" class="md-nav__link">
    <span class="md-ellipsis">
      8.5 Async Adapter Pattern (Diarization)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#86-adapter-mapping-rules" class="md-nav__link">
    <span class="md-ellipsis">
      8.6 Adapter Mapping Rules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#87-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      8.7 Error Handling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#88-internal-layer-adapters-boundary-mapping-inside-our-own-system" class="md-nav__link">
    <span class="md-ellipsis">
      8.8 Internal Layer Adapters (Boundary Mapping Inside Our Own System)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.8 Internal Layer Adapters (Boundary Mapping Inside Our Own System)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rationale-for-internal-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      Rationale for Internal Mapping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-mapping-between-internal-layers" class="md-nav__link">
    <span class="md-ellipsis">
      Example: Mapping Between Internal Layers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="objectservice-design-blueprint-integrated">Object–Service Design Blueprint (Integrated)</h1>
<p><em>A practical, opinionated blueprint for the overall direction for design, implementation, and evolution of complex objects and API-backed services across the TNH Scholar suite. It presents the big picture first, then the fine details, and ends with boilerplate templates you can copy‑paste to sketch new systems.</em></p>
<p><em>A practical, opinionated blueprint for the overall direction for design, implementation, and evolution of complex objects and API-backed services across the TNH Scholar suite. It presents the big picture first, then the fine details, and ends with boilerplate templates you can copy‑paste to sketch new systems.</em></p>
<p><strong>Version:</strong> 3.0 (Integrated)<br />
<strong>Author(s):</strong> Aaron Solomon, OpenAI GPT-5, Anthropic Claude Sonnet 4.5<br />
<strong>Date:</strong> 2025-10-24<br />
<strong>Status:</strong> Draft – for internal engineering alignment</p>
<hr />
<h2 id="0-big-picture-at-a-glance">0. Big Picture (At a Glance)</h2>
<p><strong>Goal:</strong> Ship reliable, composable features fast by separating concerns and keeping boundaries explicit.</p>
<h3 id="architectural-overview">Architectural Overview</h3>
<pre><code class="language-text">Application Layer (CLI, notebooks, web, Streamlit)
  └─ Orchestrators (thin): &lt;Feature&gt;Processor, ResultWriter
        ▲
        │ domain objects / protocols
        │
Domain Service Layer
  └─ &lt;Feature&gt;Service (Protocol-based orchestrator)
     └─ ProviderClient (impl: OpenAIClient, PyannoteClient, etc.)
        └─ RequestMapper (bi-directional: domain ↔ transport)
           └─ TransportClient (HTTP, polling, streaming)
        ▲
        │ transport models (anti-corruption boundary)
        │
Transport Layer
  └─ VendorClient  (upload/start/status/poll, retries, rate-limit)
     JobPoller     (backoff, jitter, deadline)
</code></pre>
<h3 id="unified-layer-model">Unified Layer Model</h3>
<pre><code class="language-mermaid">graph TD
  A[App / CLI] --&gt; B[Service Layer / Orchestrator]
  B --&gt; C[Port / Protocol]
  C --&gt; D[Adapter + Mapper]
  D --&gt; E[Transport Client]
  E --&gt; F[External Provider / SDK]

  subgraph Domain Layer
    B
    C
  end

  subgraph Infrastructure Layer
    D
    E
  end
</code></pre>
<h3 id="core-contracts">Core Contracts</h3>
<ul>
<li><strong>Config at init</strong>, <strong>Params per call</strong>, <strong>Response envelope</strong> always</li>
<li>Service protocol is minimal: <code>start()</code>, <code>get_response()</code>, <code>generate()</code> for async jobs; <code>generate()</code> or <code>run()</code> for sync</li>
<li>Adapter maps API shapes → canonical domain shapes (bi-directional)</li>
<li>All payloads use strong typing (Pydantic or dataclass models)</li>
<li><strong>No literals or untyped dicts</strong> in application logic</li>
</ul>
<hr />
<h2 id="1-design-goals-principles">1. Design Goals &amp; Principles</h2>
<h3 id="11-core-design-goals">1.1 Core Design Goals</h3>
<ol>
<li><strong>Strong Typing:</strong> All payloads, parameters, and responses use Pydantic or dataclass models</li>
<li><strong>No Literals:</strong> No string or numeric literals in app logic; defaults come from Settings or Policies</li>
<li><strong>Bi-directional Adapters:</strong> Each adapter maps domain → SDK (request) and SDK → domain (response)</li>
<li><strong>Protocol-based Ports:</strong> All boundaries declared as <code>Protocol</code> interfaces (structural typing)</li>
<li><strong>Replaceable Providers:</strong> Any external dependency isolated behind an adapter implementing common protocol</li>
<li><strong>Declarative Configuration:</strong> Every component derives runtime config from typed sources</li>
<li><strong>Transport / Domain Separation:</strong> Domain logic independent of serialization or transmission</li>
<li><strong>No Side-Effects in Domain:</strong> All side-effects (I/O, network) live exclusively in adapters or clients</li>
<li><strong>Explicit Boundaries:</strong> Clear separation between config, params, policy, and context</li>
</ol>
<h3 id="12-rule-of-thumb">1.2 Rule of Thumb</h3>
<ul>
<li>Wire behavior → Client</li>
<li>Canonical data shape → Adapter/Service  </li>
<li>Usage intent → Params/Policy</li>
<li>Long-lived configuration → Config/Settings</li>
<li>Defaults → Settings &lt; Pattern &lt; Policy &lt; Request (precedence order)</li>
</ul>
<hr />
<h2 id="2-core-concepts-naming-taxonomy">2. Core Concepts &amp; Naming Taxonomy</h2>
<h3 id="21-configuration-runtime-concepts">2.1 Configuration &amp; Runtime Concepts</h3>
<table>
<thead>
<tr>
<th>Concept</th>
<th>Type</th>
<th>Scope</th>
<th>Purpose</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Settings</strong></td>
<td><code>BaseSettings</code></td>
<td>Application</td>
<td>Environment/deployment config</td>
<td>API keys, base URLs, default models</td>
</tr>
<tr>
<td><strong>Config</strong></td>
<td><code>&lt;Thing&gt;Config</code></td>
<td>Service/Client</td>
<td>Construction-time settings; immutable</td>
<td>TransportConfig, ProviderConfig</td>
</tr>
<tr>
<td><strong>Params</strong></td>
<td><code>&lt;Thing&gt;Params</code></td>
<td>Per-call</td>
<td>Request-specific inputs; vary run-to-run</td>
<td>DiarizationParams, RenderRequest</td>
</tr>
<tr>
<td><strong>Policy</strong></td>
<td><code>DomainPolicy</code>, <code>ServicePolicy</code></td>
<td>Service</td>
<td>Opinionated behavior toggles</td>
<td>ParamsPolicy, completion_mode, overlap handling</td>
</tr>
<tr>
<td><strong>Pattern</strong></td>
<td><code>Pattern</code></td>
<td>Domain</td>
<td>Prompt templates with metadata</td>
<td>System/user message templates</td>
</tr>
<tr>
<td><strong>Context</strong></td>
<td><code>ExecutionContext</code></td>
<td>Pipeline</td>
<td>Ephemeral runtime state (optional)</td>
<td>Current stage, accumulated metadata</td>
</tr>
</tbody>
</table>
<h3 id="22-response-result-concepts">2.2 Response &amp; Result Concepts</h3>
<table>
<thead>
<tr>
<th>Concept</th>
<th>Type</th>
<th>Purpose</th>
<th>Presence</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Envelope</strong></td>
<td><code>Envelope</code></td>
<td>Universal response wrapper</td>
<td>Always</td>
</tr>
<tr>
<td><strong>Result</strong></td>
<td><code>&lt;Feature&gt;Result</code></td>
<td>Domain success payload</td>
<td>Only when <code>status == "succeeded"</code></td>
</tr>
<tr>
<td><strong>Response</strong></td>
<td><code>ProviderResponse</code></td>
<td>Transport-level response</td>
<td>At adapter boundary</td>
</tr>
<tr>
<td><strong>Provenance</strong></td>
<td><code>Provenance</code></td>
<td>Metadata about execution</td>
<td>Always (in Envelope)</td>
</tr>
</tbody>
</table>
<h3 id="23-architectural-concepts">2.3 Architectural Concepts</h3>
<table>
<thead>
<tr>
<th>Concept</th>
<th>Purpose</th>
<th>Location</th>
<th>Implements</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Client</strong></td>
<td>Pure transport/HTTP operations</td>
<td><code>transport/</code></td>
<td>Protocol (e.g., <code>ProviderClient</code>)</td>
</tr>
<tr>
<td><strong>Mapper</strong></td>
<td>Bi-directional type translation</td>
<td>Inside Adapter</td>
<td>Pure functions or classes</td>
</tr>
<tr>
<td><strong>Adapter</strong></td>
<td>Transport ↔ domain mapping</td>
<td><code>adapters/</code> or <code>providers/</code></td>
<td>Protocol + uses Mapper</td>
</tr>
<tr>
<td><strong>Service</strong></td>
<td>Orchestration, composes ports</td>
<td><code>service/</code></td>
<td>Protocol</td>
</tr>
<tr>
<td><strong>Processor</strong></td>
<td>Application façade</td>
<td><code>app/</code></td>
<td>Thin; wires persistence</td>
</tr>
<tr>
<td><strong>Port</strong></td>
<td>Abstract interface</td>
<td>Domain layer</td>
<td><code>Protocol</code> definition</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3-layer-structure-responsibilities">3. Layer Structure &amp; Responsibilities</h2>
<h3 id="31-conceptual-layers">3.1 Conceptual Layers</h3>
<table>
<thead>
<tr>
<th>Layer</th>
<th>Responsibility</th>
<th>Example Classes</th>
<th>Allowed Dependencies</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Application</strong></td>
<td>Entry points, user interaction</td>
<td>CLI, notebooks, Streamlit</td>
<td>Service protocols only</td>
</tr>
<tr>
<td><strong>Service (Orchestrator)</strong></td>
<td>Coordinates flow, composes ports</td>
<td><code>GenAIService</code>, <code>DiarizationService</code></td>
<td>Ports, Settings, Policy</td>
</tr>
<tr>
<td><strong>Ports (Protocols)</strong></td>
<td>Abstract interfaces</td>
<td><code>ProviderClient</code>, <code>AudioDiarizer</code></td>
<td>Domain models only</td>
</tr>
<tr>
<td><strong>Adapters</strong></td>
<td>Implement protocols, SDK mapping</td>
<td><code>OpenAIClient</code>, <code>PyannoteClient</code></td>
<td>Mappers, Transport models</td>
</tr>
<tr>
<td><strong>Mappers</strong></td>
<td>Bi-directional type translation</td>
<td><code>OpenAIRequestMapper</code></td>
<td>Transport + SDK types</td>
</tr>
<tr>
<td><strong>Transport Clients</strong></td>
<td>HTTP, polling, streaming</td>
<td><code>VendorClient</code>, <code>JobPoller</code></td>
<td>Config only</td>
</tr>
<tr>
<td><strong>Domain Models</strong></td>
<td>Typed business objects</td>
<td><code>CompletionResult</code>, <code>SpeakerBlock</code></td>
<td>Nothing (pure)</td>
</tr>
<tr>
<td><strong>Transport Models</strong></td>
<td>I/O-level contracts</td>
<td><code>ProviderRequest</code>, <code>JobStatusResponse</code></td>
<td>Nothing (pure)</td>
</tr>
</tbody>
</table>
<h3 id="32-dependency-direction">3.2 Dependency Direction</h3>
<p>Dependencies flow inward: <code>Application → Service → Port → (Adapter → Mapper → Transport Client) → External</code>.</p>
<p><strong>Forbidden dependencies:</strong></p>
<ul>
<li>Domain → Infrastructure</li>
<li>Models → Services</li>
<li>Ports → Implementations</li>
</ul>
<hr />
<h2 id="4-configuration-taxonomy">4. Configuration Taxonomy</h2>
<h3 id="41-settings-application-wide">4.1 Settings (Application-wide)</h3>
<pre><code class="language-python"># config/settings.py
from pydantic_settings import BaseSettings, SettingsConfigDict

class Settings(BaseSettings):
    &quot;&quot;&quot;Application-wide environment configuration.&quot;&quot;&quot;
    model_config = SettingsConfigDict(
        env_file=&quot;.env&quot;,
        env_file_encoding=&quot;utf-8&quot;,
        extra=&quot;ignore&quot;
    )

    # Provider credentials
    openai_api_key: str | None = None
    openai_org: str | None = None
    assemblyai_api_key: str | None = None

    # Defaults
    default_provider: str = &quot;openai&quot;
    default_model: str = &quot;gpt-4o-mini&quot;
    default_temperature: float = 0.2
    default_max_output_tokens: int = 512

    # System configuration
    log_level: str = &quot;INFO&quot;
    enable_tracing: bool = False

    @classmethod
    def from_env(cls) -&gt; &quot;Settings&quot;:
        return cls()
</code></pre>
<h3 id="42-transport-configuration">4.2 Transport Configuration</h3>
<pre><code class="language-python"># config/transport.py
from pydantic import BaseModel, Field

class TransportConfig(BaseModel):
    &quot;&quot;&quot;Pure transport/HTTP configuration; only the client sees this.&quot;&quot;&quot;
    base_url: str
    api_key: str = Field(repr=False)
    organization: str | None = None
    connect_timeout_s: float = 10.0
    read_timeout_s: float = 30.0
    max_retries: int = 5
    backoff_base_s: float = 0.5
    backoff_max_s: float = 8.0
    rate_limit_rps: float = 5.0

    @classmethod
    def from_env(cls, prefix: str) -&gt; &quot;TransportConfig&quot;:
        import os
        return cls(
            base_url=os.environ.get(f&quot;{prefix}_BASE_URL&quot;, &quot;&quot;),
            api_key=os.environ.get(f&quot;{prefix}_API_KEY&quot;, &quot;&quot;),
        )
</code></pre>
<h3 id="43-policy-structures">4.3 Policy Structures</h3>
<pre><code class="language-python"># config/policy.py
from typing import Literal
from pydantic import BaseModel

class DomainPolicy(BaseModel):
    &quot;&quot;&quot;Domain concerns about how the app wants to use the service.&quot;&quot;&quot;
    completion_mode: Literal[&quot;snapshot&quot;, &quot;wait&quot;] = &quot;wait&quot;
    deadline_s: float | None = None
    allow_partials: bool = True
    overlap_mode: Literal[&quot;ignore&quot;, &quot;merge&quot;, &quot;separate&quot;] = &quot;merge&quot;

class ServicePolicy(BaseModel):
    &quot;&quot;&quot;Adapter/service-side normalization and mapping decisions.&quot;&quot;&quot;
    default_label: str = &quot;DEFAULT&quot;
    normalize_case: bool = True
    min_unit_size: int = 0
    preserve_formatting: bool = True

class ParamsPolicy(BaseModel):
    &quot;&quot;&quot;GenAI-specific parameter precedence policy.&quot;&quot;&quot;
    provider: str
    model: str
    temperature: float
    max_output_tokens: int
    seed: int | None = None
    top_p: float | None = None
</code></pre>
<h3 id="44-policy-precedence">4.4 Policy Precedence</h3>
<p><strong>Order of precedence (highest to lowest):</strong></p>
<ol>
<li>Explicit request parameters (RenderRequest, FeatureParams)</li>
<li>Pattern defaults (from Pattern catalog)</li>
<li>Config policy (YAML or database)</li>
<li>Settings defaults (environment/deployment)</li>
</ol>
<hr />
<h2 id="5-canonical-domain-envelope">5. Canonical Domain Envelope</h2>
<h3 id="51-envelope-structure">5.1 Envelope Structure</h3>
<pre><code class="language-python"># domain/models.py
from typing import Any, Literal
from pydantic import BaseModel

class Provenance(BaseModel):
    &quot;&quot;&quot;Metadata about how/when/with what the result was produced.&quot;&quot;&quot;
    backend: str                        # e.g., &quot;openai&quot;, &quot;pyannote&quot;, &quot;assemblyai&quot;
    model: str | None = None
    job_id: str | None = None
    started_at: str | None = None
    completed_at: str | None = None
    schema_version: str = &quot;1.0&quot;
    policy_version: str = &quot;1.0&quot;
    params: dict = {}                   # Effective parameters used
    system_version: str | None = None   # Git SHA/tag for reproducibility

class Envelope(BaseModel):
    &quot;&quot;&quot;Universal response wrapper for all services.&quot;&quot;&quot;
    status: Literal[&quot;pending&quot;, &quot;running&quot;, &quot;succeeded&quot;, &quot;failed&quot;, &quot;timeout&quot;]
    result: Any | None = None           # Feature-specific; present only on success
    error: str | None = None
    diagnostics: dict = {}              # Curated metrics, not raw dump
    provenance: Provenance

    def succeeded(self) -&gt; bool:
        return self.status == &quot;succeeded&quot;

    def failed(self) -&gt; bool:
        return self.status == &quot;failed&quot;
</code></pre>
<h3 id="52-envelope-invariants">5.2 Envelope Invariants</h3>
<ul>
<li><code>result</code> only present when <code>status == "succeeded"</code></li>
<li><code>error</code> only present for <code>status == "failed"</code></li>
<li><code>provenance.job_id</code> set when available (embed at transport boundary)</li>
<li><code>diagnostics</code> contains curated, actionable metrics (not raw dumps)</li>
<li><code>provenance.params</code> records effective policy/parameters used</li>
<li>Always include <code>schema_version</code> and <code>policy_version</code> in provenance</li>
</ul>
<hr />
<h2 id="6-service-protocols">6. Service Protocols</h2>
<h3 id="61-protocol-design-rules">6.1 Protocol Design Rules</h3>
<ul>
<li>Use <code>Protocol</code> for interfaces (structural typing)</li>
<li>Use <code>ABC</code> only when enforcing init-time invariants or providing mixins</li>
<li>Every service has exactly one orchestrator class</li>
<li>Every adapter implements exactly one protocol</li>
<li>Keep protocol interfaces minimal (3-5 methods maximum)</li>
</ul>
<h3 id="62-async-job-service-protocol">6.2 Async Job Service Protocol</h3>
<pre><code class="language-python"># domain/service.py
from pathlib import Path
from typing import Protocol
from .models import Envelope

class FeatureParams(BaseModel):
    &quot;&quot;&quot;API-facing parameters (safe subset).&quot;&quot;&quot;
    pass

class AsyncFeatureService(Protocol):
    &quot;&quot;&quot;Protocol for services that support async job patterns.&quot;&quot;&quot;

    def start(
        self, 
        input_path: Path, 
        params: FeatureParams | None = None
    ) -&gt; str:
        &quot;&quot;&quot;Start async job, return job_id.&quot;&quot;&quot;
        ...

    def get_response(
        self, 
        job_id: str, 
        *, 
        wait_until_complete: bool = False
    ) -&gt; Envelope:
        &quot;&quot;&quot;Get job status/result. If wait=True, poll until complete.&quot;&quot;&quot;
        ...

    def generate(
        self, 
        input_path: Path, 
        params: FeatureParams | None = None,
        *, 
        wait_until_complete: bool = True
    ) -&gt; Envelope:
        &quot;&quot;&quot;Convenience: start + wait for result.&quot;&quot;&quot;
        ...
</code></pre>
<h3 id="63-sync-requestresponse-protocol">6.3 Sync Request/Response Protocol</h3>
<pre><code class="language-python"># domain/service.py
class SyncFeatureService(Protocol):
    &quot;&quot;&quot;Protocol for synchronous request/response services.&quot;&quot;&quot;

    def generate(self, req: RequestParams) -&gt; ResultModel:
        &quot;&quot;&quot;Synchronous generation; returns domain result directly.&quot;&quot;&quot;
        ...
</code></pre>
<h3 id="64-genai-service-protocol-example">6.4 GenAI Service Protocol (Example)</h3>
<pre><code class="language-python">class GenAIServicePort(Protocol):
    &quot;&quot;&quot;Protocol for GenAI text generation services.&quot;&quot;&quot;

    def generate(self, req: RenderRequest) -&gt; CompletionResult:
        &quot;&quot;&quot;Generate completion from rendered prompt.&quot;&quot;&quot;
        ...

class GenAIService:
    &quot;&quot;&quot;Orchestrator for GenAI generation.&quot;&quot;&quot;

    def __init__(
        self,
        settings: Settings,
        catalog: PatternCatalog | None = None,
        provider: ProviderClient | None = None,
    ):
        self.settings = settings
        self.catalog = catalog or LegacyPatternCatalog()
        self.provider = provider or OpenAIClient(
            settings.openai_api_key,
            settings.openai_org
        )

    def generate(self, req: RenderRequest) -&gt; CompletionResult:
        # 1. Get pattern from catalog
        pattern = self.catalog.get(req.pattern_key)

        # 2. Render prompt with context
        rendered = self.catalog.render(pattern, req)

        # 3. Apply policy precedence
        params = apply_policy(
            req.intent,
            pattern.default_params,
            req.model_hint
        )

        # 4. Build transport request
        provider_req = ProviderRequest(
            provider=params.provider,
            model=params.model,
            messages=rendered.messages,
            system=rendered.system,
            temperature=params.temperature,
            max_output_tokens=params.max_output_tokens,
            seed=params.seed,
        )

        # 5. Call provider through port
        resp = self.provider.generate(provider_req)

        # 6. Return domain result
        return CompletionResult(
            text=resp.text,
            usage=resp.usage,
            model=resp.model,
            provider=resp.provider,
            prompt_fingerprint=rendered.fingerprint,
        )
</code></pre>
<hr />
<h2 id="7-transport-models-domain-models">7. Transport Models &amp; Domain Models</h2>
<h3 id="71-transport-models-at-boundaries">7.1 Transport Models (at boundaries)</h3>
<pre><code class="language-python"># models/transport.py
from pydantic import BaseModel

class Message(BaseModel):
    &quot;&quot;&quot;Universal message format for chat-based APIs.&quot;&quot;&quot;
    role: Literal[&quot;system&quot;, &quot;user&quot;, &quot;assistant&quot;]
    content: str

class ProviderRequest(BaseModel):
    &quot;&quot;&quot;Transport-level request for any GenAI provider.&quot;&quot;&quot;
    provider: str
    model: str
    messages: list[Message]
    system: str | None = None
    temperature: float
    max_output_tokens: int
    seed: int | None = None
    top_p: float | None = None

class ProviderResponse(BaseModel):
    &quot;&quot;&quot;Transport-level response from GenAI provider.&quot;&quot;&quot;
    text: str
    usage: Usage
    model: str
    provider: str
    finish_reason: str | None = None

class JobStatusResponse(BaseModel):
    &quot;&quot;&quot;Transport-level job status for async services.&quot;&quot;&quot;
    status: str                    # &quot;pending&quot; | &quot;running&quot; | &quot;succeeded&quot; | &quot;failed&quot;
    job_id: str                    # Embed job_id for propagation
    elapsed_s: float = 0.0
    payload: dict = {}             # Raw vendor payload (optional)
    error: str | None = None
</code></pre>
<h3 id="72-domain-models">7.2 Domain Models</h3>
<pre><code class="language-python"># models/domain.py
from pydantic import BaseModel

class CompletionResult(BaseModel):
    &quot;&quot;&quot;Domain result for GenAI completions.&quot;&quot;&quot;
    text: str
    usage: Usage
    model: str
    provider: str
    prompt_fingerprint: str

class DiarizationResult(BaseModel):
    &quot;&quot;&quot;Domain result for speaker diarization.&quot;&quot;&quot;
    segments: list[SpeakerBlock]
    num_speakers: int
    duration_s: float

class SpeakerBlock(BaseModel):
    &quot;&quot;&quot;Individual speaker segment.&quot;&quot;&quot;
    speaker_id: str
    start_s: float
    end_s: float
    confidence: float | None = None
</code></pre>
<hr />
<h2 id="8-adapter-architecture">8. Adapter Architecture</h2>
<h3 id="81-adapter-role-responsibilities">8.1 Adapter Role &amp; Responsibilities</h3>
<p>Adapters encapsulate all external I/O logic. Each adapter:</p>
<ul>
<li>Implements exactly one <code>Protocol</code> (port)</li>
<li>Acts as <strong>bi-directional translator</strong>: domain ↔ transport ↔ SDK</li>
<li>Isolates SDK-specific code from domain logic</li>
<li>Handles provider-specific error mapping</li>
</ul>
<h3 id="82-bi-directional-mapping-contract">8.2 Bi-Directional Mapping Contract</h3>
<p>Every adapter implements request and response mapping:</p>
<pre><code class="language-python">class ProviderRequestMapper:
    &quot;&quot;&quot;Maps between domain and SDK request formats.&quot;&quot;&quot;

    def to_sdk_request(self, req: ProviderRequest) -&gt; SDKRequest:
        &quot;&quot;&quot;Domain → SDK request transformation.&quot;&quot;&quot;
        ...

    def from_sdk_response(self, resp: SDKResponse) -&gt; ProviderResponse:
        &quot;&quot;&quot;SDK → domain response transformation.&quot;&quot;&quot;
        ...
</code></pre>
<h3 id="83-adapter-boundary-diagram">8.3 Adapter Boundary Diagram</h3>
<pre><code class="language-mermaid">graph LR
  A[Domain Model] --&gt; B[ProviderRequest]
  B --&gt; C[Mapper.to_sdk_request]
  C --&gt; D[SDK Request]
  D --&gt; E[External Provider]
  E --&gt; F[SDK Response]
  F --&gt; G[Mapper.from_sdk_response]
  G --&gt; H[ProviderResponse]
  H --&gt; I[Domain Model]
</code></pre>
<h3 id="84-sync-adapter-pattern-genai">8.4 Sync Adapter Pattern (GenAI)</h3>
<pre><code class="language-python"># providers/openai_adapter.py
from openai import OpenAI

class OpenAIClient:
    &quot;&quot;&quot;Adapter for OpenAI chat completions API.&quot;&quot;&quot;
    PROVIDER = &quot;openai&quot;

    def __init__(
        self,
        api_key: str,
        organization: str,
        mapper: OpenAIRequestMapper | None = None
    ):
        self._client = OpenAI(api_key=api_key, organization=organization)
        self._mapper = mapper or OpenAIRequestMapper()

    def generate(self, req: ProviderRequest) -&gt; ProviderResponse:
        &quot;&quot;&quot;Implement ProviderClient protocol.&quot;&quot;&quot;
        # 1. Map domain → SDK
        mapped = self._mapper.to_sdk_request(req)

        # 2. Call SDK
        try:
            sdk_resp = self._client.chat.completions.create(
                **mapped.model_dump()
            )
        except Exception as e:
            raise ProviderError(f&quot;OpenAI API error: {e}&quot;) from e

        # 3. Map SDK → domain
        return self._mapper.from_sdk_response(sdk_resp)

class OpenAIRequestMapper:
    &quot;&quot;&quot;Bi-directional mapper for OpenAI API.&quot;&quot;&quot;

    def to_sdk_request(self, req: ProviderRequest) -&gt; dict:
        &quot;&quot;&quot;Convert ProviderRequest to OpenAI API format.&quot;&quot;&quot;
        messages = [{&quot;role&quot;: m.role, &quot;content&quot;: m.content} for m in req.messages]
        if req.system:
            messages.insert(0, {&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: req.system})

        return {
            &quot;model&quot;: req.model,
            &quot;messages&quot;: messages,
            &quot;temperature&quot;: req.temperature,
            &quot;max_tokens&quot;: req.max_output_tokens,
            &quot;seed&quot;: req.seed,
            &quot;top_p&quot;: req.top_p,
        }

    def from_sdk_response(self, resp) -&gt; ProviderResponse:
        &quot;&quot;&quot;Convert OpenAI response to ProviderResponse.&quot;&quot;&quot;
        return ProviderResponse(
            text=resp.choices[0].message.content,
            usage=Usage(
                input_tokens=resp.usage.prompt_tokens,
                output_tokens=resp.usage.completion_tokens,
            ),
            model=resp.model,
            provider=&quot;openai&quot;,
            finish_reason=resp.choices[0].finish_reason,
        )
</code></pre>
<h3 id="85-async-adapter-pattern-diarization">8.5 Async Adapter Pattern (Diarization)</h3>
<pre><code class="language-python"># adapters/assemblyai_adapter.py
from pathlib import Path

class AssemblyAIClient:
    &quot;&quot;&quot;Adapter for AssemblyAI async transcription API.&quot;&quot;&quot;

    def __init__(self, cfg: TransportConfig, mapper: AssemblyAIMapper):
        self.client = VendorClient(cfg)  # Transport layer
        self.mapper = mapper
        self.backend = &quot;assemblyai&quot;

    def start(self, input_path: Path, params: FeatureParams | None = None) -&gt; str:
        &quot;&quot;&quot;Start transcription job.&quot;&quot;&quot;
        media_id = self.client.upload(input_path)
        job_id = self.client.start(media_id, params.model_dump() if params else None)
        return job_id

    def get_response(
        self, 
        job_id: str, 
        *, 
        wait_until_complete: bool = False
    ) -&gt; Envelope:
        &quot;&quot;&quot;Get job status/result.&quot;&quot;&quot;
        if wait_until_complete:
            jsr = self.client.poll_until_done(job_id)
        else:
            jsr = self.client.job_status(job_id)

        return self.mapper.to_envelope(jsr)

    def generate(
        self,
        input_path: Path,
        params: FeatureParams | None = None,
        *,
        wait_until_complete: bool = True
    ) -&gt; Envelope:
        &quot;&quot;&quot;Convenience: start + wait.&quot;&quot;&quot;
        job_id = self.start(input_path, params)
        return self.get_response(job_id, wait_until_complete=wait_until_complete)

class AssemblyAIMapper:
    &quot;&quot;&quot;Maps AssemblyAI responses to domain envelopes.&quot;&quot;&quot;

    def __init__(self, backend: str = &quot;assemblyai&quot;, model: str | None = None):
        self.backend = backend
        self.model = model

    def to_envelope(self, jsr: JobStatusResponse) -&gt; Envelope:
        &quot;&quot;&quot;Convert JobStatusResponse to Envelope.&quot;&quot;&quot;
        prov = Provenance(
            backend=self.backend,
            model=self.model,
            job_id=jsr.job_id,
            params={},
        )

        if jsr.status == &quot;succeeded&quot;:
            result = self._map_result(jsr)
            return Envelope(status=&quot;succeeded&quot;, result=result, provenance=prov)
        elif jsr.status == &quot;failed&quot;:
            return Envelope(status=&quot;failed&quot;, error=jsr.error, provenance=prov)
        elif jsr.status == &quot;timeout&quot;:
            return Envelope(status=&quot;timeout&quot;, error=&quot;Job exceeded deadline&quot;, provenance=prov)
        else:
            return Envelope(status=jsr.status, provenance=prov)

    def _map_result(self, jsr: JobStatusResponse) -&gt; DiarizationResult:
        &quot;&quot;&quot;Extract domain result from vendor payload.&quot;&quot;&quot;
        # Parse vendor-specific payload → domain model
        segments = [
            SpeakerBlock(
                speaker_id=seg[&quot;speaker&quot;],
                start_s=seg[&quot;start&quot;],
                end_s=seg[&quot;end&quot;]
            )
            for seg in jsr.payload.get(&quot;utterances&quot;, [])
        ]
        return DiarizationResult(
            segments=segments,
            num_speakers=len(set(s.speaker_id for s in segments)),
            duration_s=jsr.elapsed_s
        )
</code></pre>
<h3 id="86-adapter-mapping-rules">8.6 Adapter Mapping Rules</h3>
<ul>
<li><strong>No literals or untyped dicts</strong> in mapping code; use TypedDicts or SDK models</li>
<li>All defaults come from <code>Settings</code> or <code>Policy</code></li>
<li>Mapper code is <strong>pure</strong> (no I/O, no side-effects)</li>
<li>Client code handles exceptions and wraps them as typed errors</li>
<li>Map vendor errors → <code>ProviderError</code> subclasses for uniform handling</li>
</ul>
<h3 id="87-error-handling">8.7 Error Handling</h3>
<pre><code class="language-python"># models/errors.py
class ProviderError(Exception):
    &quot;&quot;&quot;Base error for all provider failures.&quot;&quot;&quot;
    pass

class RateLimitError(ProviderError):
    &quot;&quot;&quot;Rate limit exceeded.&quot;&quot;&quot;
    pass

class AuthenticationError(ProviderError):
    &quot;&quot;&quot;Invalid credentials.&quot;&quot;&quot;
    pass

class TimeoutError(ProviderError):
    &quot;&quot;&quot;Request exceeded deadline.&quot;&quot;&quot;
    pass
</code></pre>
<p>All adapters must raise <strong>typed errors</strong> for uniform error handling by orchestration layers.</p>
<hr />
<h3 id="88-internal-layer-adapters-boundary-mapping-inside-our-own-system">8.8 Internal Layer Adapters (Boundary Mapping Inside Our Own System)</h3>
<p>Adapters and mappers are not just for translating vendor payloads—they are equally critical for translating between our own internal abstraction layers. This principle applies whenever there is a semantic boundary or abstraction shift, even within our own codebase.</p>
<h4 id="rationale-for-internal-mapping">Rationale for Internal Mapping</h4>
<ul>
<li><strong>Semantic Shifts:</strong> As data moves from transport to domain to orchestration, the meaning, required fields, or invariants of objects often change. Mapping makes these changes explicit.</li>
<li><strong>Attaching Policy, Safety, Provenance:</strong> Internal mappers are the right place to inject policy decisions, provenance metadata, or safety checks as data crosses boundaries.</li>
<li><strong>Orchestration Cleanliness:</strong> Keeping orchestration code free of manual stitching, dict access, or ad hoc conversions avoids “god services” and keeps logic testable.</li>
<li><strong>Future-Proofing:</strong> By isolating mapping, we can later support multiple result types, partial results, or envelope variants without rewriting orchestration.</li>
</ul>
<h4 id="example-mapping-between-internal-layers">Example: Mapping Between Internal Layers</h4>
<ul>
<li>
<p><strong>ProviderResponse → CompletionResult (GenAI)</strong></p>
<p>```python</p>
<h1 id="mapperscompletion_mapperpy">mappers/completion_mapper.py</h1>
<p>def to_completion_result(resp: ProviderResponse, fingerprint: str) -&gt; CompletionResult:
    return CompletionResult(
        text=resp.text,
        usage=resp.usage,
        model=resp.model,
        provider=resp.provider,
        prompt_fingerprint=fingerprint,
    )
```</p>
</li>
<li>
<p><strong>JobStatusResponse → Envelope (Async Jobs)</strong></p>
<p>```python</p>
<h1 id="mappersjob_status_mapperpy">mappers/job_status_mapper.py</h1>
<p>def to_envelope(jsr: JobStatusResponse, backend: str, model: str | None = None) -&gt; Envelope:
    prov = Provenance(
        backend=backend,
        model=model,
        job_id=jsr.job_id,
        params={},
    )
    if jsr.status == "succeeded":
        result = ...  # map jsr.payload to the domain result
        return Envelope(status="succeeded", result=result, provenance=prov)
    elif jsr.status == "failed":
        return Envelope(status="failed", error=jsr.error, provenance=prov)
    elif jsr.status == "timeout":
        return Envelope(status="timeout", error="Job exceeded deadline", provenance=prov)
    else:
        return Envelope(status=jsr.status, provenance=prov)
```</p>
</li>
</ul>
<h4 id="explicit-rules-for-internal-mapping">Explicit Rules for Internal Mapping</h4>
<ol>
<li><strong>All cross-layer translations (even internal) must happen in mappers.</strong></li>
<li><strong>Mappers are pure:</strong> No I/O, no side effects, no logging, no exception handling.</li>
<li><strong>Orchestrators never manually stitch domain objects or reach into dicts.</strong></li>
<li><strong>Naming convention:</strong> Use <code>to_&lt;DomainType&gt;()</code> or <code>&lt;DomainType&gt;Mapper</code> for class mappers.</li>
<li><strong>Class vs Function:</strong> Use a class if mapping depends on injected config or policy; use a pure function if stateless.</li>
</ol>
<h4 id="benefits">Benefits</h4>
<ul>
<li><strong>Consistency:</strong> All cross-boundary data flows are explicit and uniform.</li>
<li><strong>Testability:</strong> Mappers can be tested in isolation, including edge cases and invariants.</li>
<li><strong>Evolution:</strong> Adding new result types, partials, or shape changes is localized to mappers.</li>
<li><strong>Prevents “God Services”:</strong> Orchestration remains free of ad hoc data stitching, keeping logic readable and maintainable.</li>
</ul>
<hr />
<h2 id="9-transport-layer-clients-polling">9. Transport Layer: Clients &amp; Polling</h2>
<h3 id="91-transport-client-http-operations">9.1 Transport Client (HTTP operations)</h3>
<pre><code class="language-python"># transport/client.py
import time
from pathlib import Path
from .models import JobStatusResponse

class VendorClient:
    &quot;&quot;&quot;Pure transport/HTTP client for async job APIs.&quot;&quot;&quot;

    def __init__(self, cfg: TransportConfig):
        self.cfg = cfg
        self._session = self._create_session()

    def _create_session(self):
        &quot;&quot;&quot;Create HTTP session with retries and rate limiting.&quot;&quot;&quot;
        # Implementation details...
        pass

    def upload(self, path: Path) -&gt; str:
        &quot;&quot;&quot;Upload file to vendor, return media_id.&quot;&quot;&quot;
        # POST file → return ID
        return &quot;media_123&quot;

    def start(self, media_id: str, params: dict | None = None) -&gt; str:
        &quot;&quot;&quot;Start processing job, return job_id.&quot;&quot;&quot;
        # POST /jobs → return job_id
        return &quot;job_abc&quot;

    def job_status(self, job_id: str) -&gt; JobStatusResponse:
        &quot;&quot;&quot;Get current job status.&quot;&quot;&quot;
        # GET /jobs/{job_id} → JobStatusResponse
        return JobStatusResponse(status=&quot;running&quot;, job_id=job_id)

    def poll_until_done(
        self,
        job_id: str,
        deadline_s: float | None = None
    ) -&gt; JobStatusResponse:
        &quot;&quot;&quot;Poll job until completion with exponential backoff.&quot;&quot;&quot;
        backoff = self.cfg.backoff_base_s
        start = time.time()

        while True:
            jsr = self.job_status(job_id)

            # Terminal states
            if jsr.status in {&quot;succeeded&quot;, &quot;failed&quot;}:
                return jsr

            # Timeout check
            if deadline_s and (time.time() - start) &gt; deadline_s:
                return JobStatusResponse(
                    status=&quot;timeout&quot;,
                    job_id=job_id,
                    elapsed_s=time.time() - start
                )

            # Exponential backoff with jitter
            time.sleep(backoff + random.uniform(0, backoff * 0.1))
            backoff = min(backoff * 1.6, self.cfg.backoff_max_s)
</code></pre>
<h3 id="92-job-poller-reusable">9.2 Job Poller (Reusable)</h3>
<pre><code class="language-python"># transport/poller.py
from typing import Callable, TypeVar
import time
import random

T = TypeVar('T')

class JobPoller:
    &quot;&quot;&quot;Reusable polling logic with backoff and jitter.&quot;&quot;&quot;

    def __init__(
        self,
        check_fn: Callable[[str], T],
        is_terminal: Callable[[T], bool],
        backoff_base: float = 0.5,
        backoff_max: float = 8.0,
        deadline_s: float | None = None
    ):
        self.check_fn = check_fn
        self.is_terminal = is_terminal
        self.backoff_base = backoff_base
        self.backoff_max = backoff_max
        self.deadline_s = deadline_s

    def poll(self, job_id: str) -&gt; T:
        &quot;&quot;&quot;Poll until terminal state or timeout.&quot;&quot;&quot;
        backoff = self.backoff_base
        start = time.time()

        while True:
            result = self.check_fn(job_id)

            if self.is_terminal(result):
                return result

            if self.deadline_s and (time.time() - start) &gt; self.deadline_s:
                raise TimeoutError(f&quot;Job {job_id} exceeded deadline&quot;)

            jitter = random.uniform(0, backoff * 0.1)
            time.sleep(backoff + jitter)
            backoff = min(backoff * 1.6, self.backoff_max)
</code></pre>
<hr />
<h2 id="10-testing-strategy">10. Testing Strategy</h2>
<h3 id="101-unit-testing-mock-protocols">10.1 Unit Testing (Mock Protocols)</h3>
<pre><code class="language-python"># tests/test_service.py
class FakeProviderClient:
    &quot;&quot;&quot;Mock implementation of ProviderClient protocol.&quot;&quot;&quot;

    def generate(self, req: ProviderRequest) -&gt; ProviderResponse:
        return ProviderResponse(
            text=&quot;mocked response&quot;,
            usage=Usage(input_tokens=10, output_tokens=20),
            model=req.model,
            provider=&quot;fake&quot;
        )

def test_generate():
    &quot;&quot;&quot;Test service orchestration with mocked provider.&quot;&quot;&quot;
    fake_provider = FakeProviderClient()
    settings = Settings(default_provider=&quot;fake&quot;)
    service = GenAIService(settings, provider=fake_provider)

    req = RenderRequest(pattern_key=&quot;test&quot;, context={})
    result = service.generate(req)

    assert result.text == &quot;mocked response&quot;
    assert result.provider == &quot;fake&quot;
</code></pre>
<h3 id="102-integration-testing">10.2 Integration Testing</h3>
<pre><code class="language-python"># tests/integration/test_openai.py
def test_openai_integration():
    &quot;&quot;&quot;End-to-end test with real OpenAI API.&quot;&quot;&quot;
    settings = Settings.from_env()
    service = GenAIService(settings)

    req = RenderRequest(
        pattern_key=&quot;summarize&quot;,
        context={&quot;text&quot;: &quot;Long document...&quot;}
    )
    result = service.generate(req)

    assert result.succeeded()
    assert len(result.text) &gt; 0
</code></pre>
<h3 id="103-contract-testing-envelope-shape">10.3 Contract Testing (Envelope Shape)</h3>
<pre><code class="language-python">def test_envelope_contract():
    &quot;&quot;&quot;Verify envelope always contains required fields.&quot;&quot;&quot;
    env = service.get_response(job_id)

    assert hasattr(env, &quot;status&quot;)
    assert hasattr(env, &quot;provenance&quot;)
    assert env.provenance.backend is not None
    assert env.provenance.schema_version is not None

    if env.succeeded():
        assert env.result is not None
        assert env.error is None
</code></pre>
<h3 id="104-golden-testing-policy-variants">10.4 Golden Testing (Policy Variants)</h3>
<p>For each policy profile, snapshot the envelope shape to detect regressions.</p>
<hr />
<h2 id="11-interface-modalities-integration-patterns">11. Interface Modalities &amp; Integration Patterns</h2>
<p>Design for a range of service shapes. Choose the smallest that fits; keep the envelope consistent.</p>
<h3 id="111-modality-decision-tree">11.1 Modality Decision Tree</h3>
<ol>
<li><strong>Is the task fast (&lt;2s)?</strong> → Synchronous request/response</li>
<li><strong>Long-running and vendor can't call back?</strong> → Async + polling</li>
<li><strong>Vendor supports webhooks and you can host an endpoint?</strong> → Async + webhook</li>
<li><strong>You need incremental UX?</strong> → Streaming</li>
<li><strong>You need decoupling/scale?</strong> → Message queue / Pub-Sub</li>
<li><strong>It's a local library?</strong> → Synchronous or streaming</li>
</ol>
<h3 id="112-synchronous-requestresponse">11.2 Synchronous Request/Response</h3>
<p><strong>When to use:</strong> Small/fast tasks; local libraries; remote endpoints with low latency.</p>
<ul>
<li><strong>Contract:</strong> <code>run(params) -&gt; Envelope</code> (no <code>start()</code>/<code>get_response()</code>)</li>
<li><strong>Failure model:</strong> Exceptions for programmer errors; <code>failed</code> envelope for domain/remote errors</li>
<li><strong>Examples:</strong> Local Whisper inference; lightweight text cleaners; GenAI completions</li>
</ul>
<h3 id="113-asynchronous-jobs-with-polling">11.3 Asynchronous Jobs with Polling</h3>
<p><strong>When to use:</strong> Long-running tasks without push callbacks.</p>
<ul>
<li><strong>Contract:</strong> <code>start() -&gt; job_id</code>, <code>get_response(job_id, wait|snapshot) -&gt; Envelope</code></li>
<li><strong>Failure model:</strong> Timeouts → <code>timeout</code> envelope (optionally partials); network errors retried</li>
<li><strong>Examples:</strong> Diarization, transcription, video processing</li>
</ul>
<h3 id="114-asynchronous-jobs-with-webhooks">11.4 Asynchronous Jobs with Webhooks</h3>
<p><strong>When to use:</strong> Vendor can push results; you control an HTTP endpoint.</p>
<ul>
<li><strong>Contract:</strong> <code>start(callback_url) -&gt; job_id</code>; callback sends transport payload; adapter maps to envelope</li>
<li><strong>Failure model:</strong> At-least-once delivery; verify signatures; be idempotent</li>
</ul>
<pre><code class="language-python"># app/webhooks.py
from fastapi import FastAPI, Request, HTTPException

app = FastAPI()

@app.post(&quot;/callbacks/vendor&quot;)
async def vendor_callback(req: Request):
    sig = req.headers.get(&quot;X-Vendor-Signature&quot;)
    body = await req.json()

    if not verify_signature(sig, body):
        raise HTTPException(status_code=401)

    jsr = JobStatusResponse.model_validate({
        **body,
        &quot;job_id&quot;: body.get(&quot;job_id&quot;)
    })
    env = adapter.to_envelope(jsr)
    save_result(env)  # Persist; notify UI

    return {&quot;ok&quot;: True}
</code></pre>
<h3 id="115-streaming-sse-websocket-grpc">11.5 Streaming (SSE / WebSocket / gRPC)</h3>
<p><strong>When to use:</strong> Incremental results (tokens, segments, progress).</p>
<ul>
<li><strong>Contract:</strong> Open stream → receive <code>Envelope</code> deltas or <code>Progress</code> events; final <code>Envelope</code> closes stream</li>
<li><strong>Failure model:</strong> Reconnect with resume tokens; dedupe by <code>event_id</code></li>
<li><strong>Notes:</strong> Wrap stream events into mini-envelopes for consistent shape</li>
</ul>
<pre><code class="language-python"># Example: async streaming client
async def consume_stream(uri: str):
    async with websockets.connect(uri) as ws:
        await ws.send(json.dumps({&quot;auth&quot;: token, &quot;params&quot;: {...}}))
        async for msg in ws:
            evt = json.loads(msg)
            env = to_envelope(evt)  # Mini-envelopes or progress events
            handle_event(env)
</code></pre>
<h3 id="116-message-queue-pub-sub-integration">11.6 Message Queue / Pub-Sub Integration</h3>
<p><strong>When to use:</strong> Decouple producers/consumers; batch pipelines; fan-out/fan-in.</p>
<ul>
<li><strong>Contract:</strong> Publish <code>Params</code> + correlation IDs; consumers emit <code>Envelope</code>s on result topic</li>
<li><strong>Failure model:</strong> Retries with DLQ; ensure idempotency via keys</li>
</ul>
<pre><code class="language-python">@mq.consume(&quot;transcribe.jobs&quot;)
def worker(msg):
    params = FeatureParams.model_validate(msg[&quot;params&quot;])
    env = service.generate(Path(msg[&quot;input&quot;]), params)
    mq.publish(&quot;transcribe.results&quot;, env.model_dump())
</code></pre>
<h3 id="117-batch-pipelines-orchestration">11.7 Batch Pipelines (Orchestration)</h3>
<p><strong>When to use:</strong> Multi-stage processing: diarize → chunk → transcribe → summarize.</p>
<ul>
<li><strong>Contract:</strong> Each stage returns an <code>Envelope</code>; orchestrator composes; pass along <code>provenance</code> and <code>policy</code></li>
<li><strong>Failure model:</strong> Saga-style compensation/skip policies; partial results acceptable per policy</li>
</ul>
<hr />
<h2 id="12-tracing-metrics-observability">12. Tracing, Metrics &amp; Observability</h2>
<h3 id="121-instrumentation-boundaries">12.1 Instrumentation Boundaries</h3>
<table>
<thead>
<tr>
<th>Layer</th>
<th>Responsibility</th>
<th>Tools</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Domain</strong></td>
<td>Trace spans, usage accounting</td>
<td><code>Tracer</code>, <code>UsageAccounting</code></td>
</tr>
<tr>
<td><strong>Adapter</strong></td>
<td>Metrics (latency, cost, throughput)</td>
<td>Prometheus, DataDog</td>
</tr>
<tr>
<td><strong>Transport</strong></td>
<td>HTTP metrics, retry counts</td>
<td>Built-in client metrics</td>
</tr>
</tbody>
</table>
<h3 id="122-provenance-integration">12.2 Provenance Integration</h3>
<p>Always record in <code>provenance.params</code>:</p>
<ul>
<li>Policy and policy version used</li>
<li>System version (git SHA/tag) for reproducibility</li>
<li>Upstream IDs (job_id/request_id) and correlation IDs</li>
<li>When combining stages, <strong>aggregate provenance</strong>: keep list of stage-level blocks</li>
</ul>
<hr />
<h2 id="13-policy-evolution-strategy">13. Policy Evolution Strategy</h2>
<h3 id="131-principles">13.1 Principles</h3>
<ol>
<li><strong>Policy ≠ Config:</strong> Policies affect semantics; configs describe environment</li>
<li><strong>Additive first:</strong> Prefer adding new policy fields with sensible defaults over changing semantics</li>
<li><strong>Version the policy surface:</strong> Include <code>policy_version</code> in provenance</li>
<li><strong>Document intent:</strong> Every policy field gets one-line rationale in docstrings</li>
<li><strong>Record used policy:</strong> Echo effective policy into <code>provenance.policy</code> on every response</li>
</ol>
<h3 id="132-versioning">13.2 Versioning</h3>
<ul>
<li>Add <code>policy_version: str = "1.0"</code> to policy model</li>
<li>Bump minor (<code>1.1</code>) for additive fields; bump major (<code>2.0</code>) for behavior changes</li>
<li>Store version in <code>provenance.params["policy_version"]</code></li>
</ul>
<h3 id="133-migration-patterns">13.3 Migration Patterns</h3>
<p><strong>Expand → Contract:</strong></p>
<ul>
<li>Ship new policy fields with defaults that preserve old behavior</li>
<li>Gather metrics; then flip defaults in major version</li>
</ul>
<p><strong>Feature flags:</strong></p>
<ul>
<li>Use boolean or enum policy switches for new behaviors (e.g., <code>overlap_mode = "ignore|merge|separate"</code>)</li>
</ul>
<p><strong>Policy profiles:</strong></p>
<ul>
<li>Provide named presets (e.g., <code>"dharma_talks"</code>, <code>"interviews"</code>) that resolve to concrete policy objects</li>
</ul>
<p><strong>Deprecation path:</strong></p>
<ul>
<li>Mark fields as deprecated in docstrings</li>
<li>Log deprecation warnings when used</li>
<li>Remove only after major version bump</li>
</ul>
<h3 id="134-testing-governance">13.4 Testing &amp; Governance</h3>
<ul>
<li><strong>Golden tests</strong> for policy variants: snapshot envelope shape for each profile</li>
<li><strong>Contract tests</strong> to verify provenance always includes policy version and effective values</li>
<li><strong>Review checklist</strong> for policy PRs: rationale, defaults, migration notes, docstrings, provenance echo</li>
</ul>
<hr />
<h2 id="14-key-implementation-rules">14. Key Implementation Rules</h2>
<ol>
<li>Use <code>Protocol</code> for interfaces; use <code>ABC</code> only when enforcing init-time invariants or providing mixins</li>
<li>Every service has exactly one orchestrator class</li>
<li>Every adapter implements exactly one protocol</li>
<li>Mappers are pure and side-effect-free</li>
<li>No dicts except at SDK boundaries (use TypedDict or Pydantic models)</li>
<li>All literals replaced by settings/policy parameters</li>
<li>Exceptions wrapped in typed error classes</li>
<li>Config at init, params per call, response envelope always</li>
<li>Domain logic never depends on infrastructure</li>
<li>All side-effects isolated to adapters and transport clients</li>
</ol>
<hr />
<h2 id="15-reference-implementation-index">15. Reference Implementation Index</h2>
<table>
<thead>
<tr>
<th>Concept</th>
<th>GenAI Service</th>
<th>Diarization Service</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Orchestrator</strong></td>
<td><code>service.py</code> (GenAIService)</td>
<td><code>diarization_service.py</code></td>
</tr>
<tr>
<td><strong>Provider Client</strong></td>
<td><code>providers/openai_adapter.py</code></td>
<td><code>adapters/pyannote_client.py</code></td>
</tr>
<tr>
<td><strong>Mapper</strong></td>
<td><code>OpenAIRequestMapper</code></td>
<td><code>PyannoteMapper</code></td>
</tr>
<tr>
<td><strong>Domain Models</strong></td>
<td><code>models/domain.py</code></td>
<td><code>models/audio_domain.py</code></td>
</tr>
<tr>
<td><strong>Transport Models</strong></td>
<td><code>models/transport.py</code></td>
<td><code>models/audio_transport.py</code></td>
</tr>
<tr>
<td><strong>Errors</strong></td>
<td><code>models/errors.py</code></td>
<td><code>models/errors.py</code></td>
</tr>
<tr>
<td><strong>Transport Client</strong></td>
<td>(direct SDK call)</td>
<td><code>transport/vendor_client.py</code></td>
</tr>
<tr>
<td><strong>Job Poller</strong></td>
<td>(N/A - sync)</td>
<td><code>transport/poller.py</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="16-filemodule-scaffold-cookie-ready">16. File/Module Scaffold (Cookie-Ready)</h2>
<pre><code class="language-text">&lt;feature&gt;/
  config/
    settings.py          # Application-wide settings
    transport.py         # Transport configuration
    policy.py            # Domain/service policies
  domain/
    models.py            # Domain models (Result, Envelope)
    service.py           # Service protocol definition
  transport/
    client.py            # HTTP client (upload, start, poll)
    poller.py            # Reusable polling logic
    models.py            # Transport models (JobStatusResponse)
  adapters/  (or providers/)
    &lt;vendor&gt;_client.py   # Adapter implementing protocol
    &lt;vendor&gt;_mapper.py   # Bi-directional mapper
  service/
    &lt;vendor&gt;_service.py  # Service orchestrator (composes ports)
  app/
    processor.py         # Application façade
    cli.py               # CLI entry point
  models/
    errors.py            # Typed error hierarchy
</code></pre>
<hr />
<h2 id="17-design-review-questions">17. Design Review Questions</h2>
<ol>
<li><strong>Error Granularity:</strong> Should <code>ProviderError</code> be subclassed per provider or remain generic?</li>
<li><strong>Tracing Interface:</strong> Centralized or service-local?</li>
<li><strong>Policy Loading:</strong> Should YAML policy files be lazy-loaded or pre-loaded at startup?</li>
<li><strong>Composite PatternCatalog:</strong> Should multiple pattern sources (file, legacy, DB) be supported concurrently?</li>
<li><strong>RetryPolicy Abstraction:</strong> Should retries be unified across audio + text services or service-specific?</li>
<li><strong>Mappers as Classes vs Functions:</strong> Currently class-based; function-based mappers could simplify small providers</li>
<li><strong>Streaming:</strong> Should streaming adapters implement an async interface (<code>ProviderClientAsync</code>)?</li>
<li><strong>Webhook Security:</strong> Standardize signature verification across all webhook-based integrations?</li>
<li><strong>Rate Limiting:</strong> Client-side vs server-enforced; per-provider or global?</li>
<li><strong>Partial Results:</strong> How to handle and represent partial results in envelopes for long-running jobs?</li>
</ol>
<hr />
<h2 id="18-glossary">18. Glossary</h2>
<table>
<thead>
<tr>
<th>Term</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Adapter</strong></td>
<td>Component that implements a protocol; maps between domain and transport</td>
</tr>
<tr>
<td><strong>Anti-corruption layer</strong></td>
<td>Boundary that converts vendor shapes to domain shapes</td>
</tr>
<tr>
<td><strong>Envelope</strong></td>
<td>Universal response wrapper containing status, diagnostics, provenance, and optional result</td>
</tr>
<tr>
<td><strong>Mapper</strong></td>
<td>Pure component performing bi-directional type translation</td>
</tr>
<tr>
<td><strong>Policy</strong></td>
<td>Opinionated settings that change behavior but not capability</td>
</tr>
<tr>
<td><strong>Port</strong></td>
<td>Abstract interface defined as Protocol</td>
</tr>
<tr>
<td><strong>Provenance</strong></td>
<td>Metadata about how/when/with what the result was produced</td>
</tr>
<tr>
<td><strong>Protocol</strong></td>
<td>Structural type interface (no inheritance required)</td>
</tr>
<tr>
<td><strong>Transport</strong></td>
<td>Layer handling HTTP, polling, streaming, and retries</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="19-evolution-versioning">19. Evolution &amp; Versioning</h2>
<ul>
<li>Version the envelope (<code>schema_version</code>) and keep changes additive where possible</li>
<li>Be adapter-tolerant to unknown transport fields</li>
<li>For breaking API shifts, add new adapter/service and migrate gradually</li>
<li>Include <code>policy_version</code> and <code>system_version</code> in provenance for reproducibility</li>
<li>Aggregate provenance when combining stages in pipelines</li>
</ul>
<hr />
<h2 id="20-closing-notes">20. Closing Notes</h2>
<p>This blueprint is <strong>modality-agnostic</strong>, <strong>policy-forward</strong>, and <strong>strongly-typed</strong>. It unifies patterns for:</p>
<ul>
<li>Synchronous request/response (GenAI)</li>
<li>Asynchronous job polling (diarization, transcription)</li>
<li>Webhooks, streaming, message queues</li>
</ul>
<p><strong>Core principles:</strong></p>
<ul>
<li>Use the smallest viable integration pattern</li>
<li>Keep envelopes consistent across modalities</li>
<li>Let policy express domain decisions</li>
<li>Maintain strong typing with no literals</li>
<li>Persist provenance for debugging and reproducibility</li>
</ul>
<p><strong>Key success metrics:</strong></p>
<ul>
<li>Can add new provider in &lt;1 day</li>
<li>Can swap providers without changing application code</li>
<li>Can trace any result back to exact parameters/version used</li>
<li>Can test services in isolation with mocked protocols</li>
</ul>
<p>Copy the scaffolds and stubs from this blueprint to start new features quickly while maintaining architectural consistency.</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
    
  </body>
</html>